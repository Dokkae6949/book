<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Event queues and filters - The Smithay Handbook</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../client/intro.html"><strong aria-hidden="true">1.</strong> Wayland apps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../client/general/intro.html"><strong aria-hidden="true">1.1.</strong> General principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../client/general/objects.html"><strong aria-hidden="true">1.1.1.</strong> Objects</a></li><li class="chapter-item expanded "><a href="../../client/general/event_queues.html" class="active"><strong aria-hidden="true">1.1.2.</strong> Event queues and filters</a></li><li class="chapter-item expanded "><a href="../../client/general/initializing.html"><strong aria-hidden="true">1.1.3.</strong> Initializing an app</a></li><li class="chapter-item expanded "><a href="../../client/general/registry.html"><strong aria-hidden="true">1.1.4.</strong> The registry and globals</a></li></ol></li><li class="chapter-item expanded "><a href="../../client/sctk/intro.html"><strong aria-hidden="true">1.2.</strong> Getting started with SCTK</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../client/sctk/environment.html"><strong aria-hidden="true">1.2.1.</strong> The Environment</a></li><li class="chapter-item expanded "><a href="../../client/sctk/window.html"><strong aria-hidden="true">1.2.2.</strong> Creating a Window</a></li><li class="chapter-item expanded "><a href="../../client/sctk/drawing.html"><strong aria-hidden="true">1.2.3.</strong> Drawing to a Window</a></li><li class="chapter-item expanded "><a href="../../client/sctk/image_viewer.html"><strong aria-hidden="true">1.2.4.</strong> Exercise: an image viewer</a></li></ol></li><li class="chapter-item expanded "><strong aria-hidden="true">1.3.</strong> Processing user input</li><li><ol class="section"><li class="chapter-item expanded "><strong aria-hidden="true">1.3.1.</strong> The seats</li><li class="chapter-item expanded "><strong aria-hidden="true">1.3.2.</strong> Pointers</li><li class="chapter-item expanded "><strong aria-hidden="true">1.3.3.</strong> Keyboards</li><li class="chapter-item expanded "><strong aria-hidden="true">1.3.4.</strong> Touchscreens</li></ol></li><li class="chapter-item expanded "><strong aria-hidden="true">1.4.</strong> Multiple outputs and HiDPI</li><li class="chapter-item expanded "><strong aria-hidden="true">1.5.</strong> Cliboard and Drag'n'Drop</li><li class="chapter-item expanded "><strong aria-hidden="true">1.6.</strong> Drawing with OpenGL</li></ol></li><li class="chapter-item expanded "><a href="../../server/intro.html"><strong aria-hidden="true">2.</strong> Wayland Compositors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Smithay Handbook</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#event-queues-and-filters" id="event-queues-and-filters">Event queues and filters</a></h1>
<p>If the <a href="https://docs.rs/wayland-client/*/wayland_client/struct.Display.html"><code>Display</code></a> is the heart of your Wayland app, the <a href="https://docs.rs/wayland-client/*/wayland_client/struct.EventQueue.html"><code>EventQueue</code></a> will be its
backbone. As described in the previous section, messages are sent in both directions,
and so far we only discussed how to send requests (using the methods of bare proxies),
but not how to receive events. This is done via event queues and callbacks.</p>
<h2><a class="header" href="#event-callbacks" id="event-callbacks">Event callbacks</a></h2>
<p>Each protocol object can be assigned to a callback, which will be invoked whenever
this object receives an event. The event callback receives 3 arguments:</p>
<ul>
<li>a <code>Main&lt;_&gt;</code> proxy to the object this event is associated to</li>
<li>the event itself, under the form of the <code>Event</code> enum of the interface of this object</li>
<li>a mutable reference to the <code>DispatchData</code>, which is some global mutable state shared
by the event queue (we will get into details about that when explaining the event queue)</li>
</ul>
<p>This callback should then contain the logic of your program for handling this event. This
may require anything from just storing the new information somewhere to process it later,
to directly responding to the server by sending a request, from within the callback.</p>
<p>The direct way to assign a callback to an object is via the 
<a href="https://docs.rs/wayland-client/*/wayland_client/struct.Main.html#method.quick_assign"><code>Main&lt;_&gt;::quick_assign()</code></a>
method, which requires to be given a callback under the form of an <code>FnMut</code> closure. You can
thus capture values in the callback, but it must be a <code>'static</code> closure, so it cannot
capture references, only values (this implies it must be a <code>move</code> closure if it captures
anything).</p>
<p>An alternative approach is to use a <a href="https://docs.rs/wayland-client/*/wayland_client/struct.Filter.html"><code>Filter</code></a>. You can think of filters as a <code>Rc&lt;_&gt;</code> wrapper
around a closure. Filters allow you to use the same closure to process events from several
objects, making state sharing easier. They are a more advanced use, and we shall come back to
them later.</p>
<h2><a class="header" href="#event-queues-and-attached-proxies" id="event-queues-and-attached-proxies">Event queues and Attached proxies</a></h2>
<p><a href="https://docs.rs/wayland-client/*/wayland_client/struct.EventQueue.html"><code>EventQueue</code></a>s are the type which actually read events from the Wayland socket, and
invoke your appropriate callbacks. All protocol objects are associated at creation to an
event queue so that their events are processed.</p>
<p>This is where the <code>Attached&lt;_&gt;</code> proxies come into play. Given a <code>Proxy&lt;_&gt;</code>, you can attach
it to an <a href="https://docs.rs/wayland-client/*/wayland_client/struct.EventQueue.html"><code>EventQueue</code></a> like so, using a event queue token:</p>
<pre><pre class="playground"><code class="language-rust no_run">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let attached_proxy = proxy.attach(&amp;event_queue.token());
<span class="boring">}
</span></code></pre></pre>
<p>Attaching a proxy only affects the proxy, not the protocol object. The effect is that whenever
a request is sent that creates a new object, this newly created object will be associated to
the event queue to which its creator proxy is attached. Given an object must always be associated
with an event queue, requests creating new object are thus only allowed from <code>Attached&lt;_&gt;</code>
proxies. <code>Main&lt;_&gt;</code> proxies behave like <code>Attached&lt;_&gt;</code> ones, being attached to the same queue
as the one the underlying object is associated to. Creating new objects directly from the
same event queue as their parent object is by far the most frequent case.</p>
<p><a href="https://docs.rs/wayland-client/*/wayland_client/struct.EventQueue.html"><code>EventQueue</code></a>s are cannot be shared between threads (they are <code>!Send</code> and <code>!Sync</code>),
this mechanism thus allow to associate different objects to different queues, and
potentially different threads, and is required for handling that in a threadsafe way.
Following that, <code>Attached&lt;WlFoo&gt;</code> and <code>Main&lt;WlFoo&gt;</code> are not <code>Send</code> either, while
<code>WlFoo</code> and <code>Proxy&lt;WlFoo&gt;</code> are.</p>
<h2><a class="header" href="#dispatching-event-queues" id="dispatching-event-queues">Dispatching event queues</a></h2>
<p>To receive events, it is necessary to read the Wayland socket and call the appropriate callbacks.
We call this process &quot;dispatching&quot;, and as <code>wayland-client</code> does not take the control-flow away
from you, you need to tell it to do it.</p>
<p>The simplest way to achieve that is with the
<a href="https://docs.rs/wayland-client/*/wayland_client/struct.EventQueue.html#method.dispatch"><code>EventQueue::dispatch()</code></a>
method. This method does three things:</p>
<ul>
<li>Flush the outgoing buffer (when sending a request, it is not directly written to the socket but instead
buffered, to improve performance)</li>
<li>Read pending events from the socket, if none are available block until some are received, and distribute
these events to the internal buffer of their target event queue</li>
<li>Empty the internal buffer of the event queue on which the method was called by invoking the appropriate
callbacks</li>
</ul>
<p>This method also requires you to provide two additional arguments:</p>
<ul>
<li>A mutable reference to some value <code>&amp;mut T</code>: this reference is accessible from all callbacks invoked by this
event queue as the <code>&amp;mut DispatchData</code> argument. If they wish to use it, the callbacks need to handle the
downcasting using the methods provided by <a href="https://docs.rs/wayland-client/*/wayland_client/struct.DispatchData.html"><code>DispatchData</code></a>, in a similar fashion as <code>Any</code>. This value is
typically used to serve as the global state of your app.</li>
<li>A fallback closure. This closure will be invoked for all events associated to an object which has not been
assigned to a callback using <code>quick_assign()</code> or <code>assign()</code>. This is aimed at providing an alternative
way to handle messages in a more centralized fashion, but at the moment the API is still very limited.
You can check <a href="https://github.com/Smithay/wayland-rs/issues/287">this Github issue</a> to follow its evolution.</li>
</ul>
<p>If most of your logic resides in callbacks, the main loop of your app can thus be as simple as:</p>
<pre><pre class="playground"><code class="language-rust no_run">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>loop {
    let ret = event_queue.dispatch(
        &amp;mut global_state,
        |_,_,_| panic!(&quot;An event was received not assigned to any callback!&quot;)
    );
    if let Err(e) = ret {
        // Some error was returned, this means that the Wayland connection is lost
        // most of the time there is nothing more to do than print a nice error message
        // and exit
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>If you need a more complex handling of the dispatching (in the case of a multithreaded app, or
if you have more than one source of events to handle), the three steps (flushing the outgoing buffer,
reading the socket, and dispatching the events) can be done independently using respectively
<a href="https://docs.rs/wayland-client/*/wayland_client/struct.Display.html#method.flush"><code>Display::flush()</code></a>,
<a href="https://docs.rs/wayland-client/*/wayland_client/struct.EventQueue.html#method.prepare_read"><code>EventQueue::prepare_read()</code></a>, and
<a href="https://docs.rs/wayland-client/*/wayland_client/struct.EventQueue.html#method.dispatch_pending"><code>EventQueue::dispatch_pending()</code></a>.</p>
<p>Having this in mind, let's see in the next part how to proceed to the initial setup of a Wayland app.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../client/general/objects.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../client/general/initializing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../client/general/objects.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../client/general/initializing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
